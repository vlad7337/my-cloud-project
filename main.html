<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Event Planner | GitHub Actions Proxy</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-200">
        <div class="bg-indigo-600 p-6">
            <h1 class="text-2xl font-bold text-white flex items-center gap-2">
                <span>üìÖ</span> –•–º–∞—Ä–Ω–∏–π –ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫
            </h1>
            <p class="text-indigo-100 text-sm mt-1">–ë–µ–∑–ø–µ—á–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —á–µ—Ä–µ–∑ GitHub Actions Proxy</p>
        </div>

        <div class="p-6">
            <div class="flex gap-2 mb-8">
                <input type="text" id="taskInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤—É –ø–æ–¥—ñ—é..." 
                       class="flex-1 border border-slate-300 rounded-lg px-4 py-2 outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                <button onclick="addTask()" 
                        class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-indigo-700 active:scale-95 transition-all">
                    –î–æ–¥–∞—Ç–∏
                </button>
            </div>

            <div class="space-y-4">
                <h2 class="text-lg font-semibold text-slate-700 flex justify-between">
                    –°–ø–∏—Å–æ–∫ –ø–ª–∞–Ω—ñ–≤
                    <span id="loadingSpinner" class="hidden animate-spin">‚öôÔ∏è</span>
                </h2>
                <ul id="taskList" class="space-y-3">
                    </ul>
            </div>

            <div class="mt-10 pt-6 border-t border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-2 text-sm">
                    <div id="statusIndicator" class="w-3 h-3 rounded-full bg-slate-300"></div>
                    <span id="statusText" class="text-slate-600">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</span>
                </div>
                <div class="flex gap-4">
                    <button onclick="clearToken()" class="text-xs text-red-500 hover:underline">–í–∏–¥–∞–ª–∏—Ç–∏ —Ç–æ–∫–µ–Ω –∑ –ø–∞–º'—è—Ç—ñ</button>
                    <button onclick="fetchFromGitHub()" class="text-xs text-indigo-600 font-medium">–û–Ω–æ–≤–∏—Ç–∏ –¥–∞–Ω—ñ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            owner: 'vlad7337', 
            repo: 'my-cloud-project',
            path: 'data/tasks.json'
        };

        let tasks = [];

        // –§—É–Ω–∫—Ü—ñ—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–æ–∫–µ–Ω–∞ (–Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –≤ –∫–æ–¥—ñ)
        function getToken() {
            let token = sessionStorage.getItem('gh_token');
            if (!token) {
                token = prompt("–í–≤–µ–¥—ñ—Ç—å –≤–∞—à GitHub Personal Access Token (PAT):");
                if (token) sessionStorage.setItem('gh_token', token);
            }
            return token;
        }

        function clearToken() {
            sessionStorage.removeItem('gh_token');
            location.reload();
        }

        // 1. –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø (–ü—É–±–ª—ñ—á–Ω–∏–π –¥–æ—Å—Ç—É–ø –∑–∞–∑–≤–∏—á–∞–π –¥–æ–∑–≤–æ–ª–µ–Ω–∏–π –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è)
        async function fetchFromGitHub() {
            updateStatus('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...', 'bg-yellow-500');
            try {
                // –î–æ–¥–∞—î–º–æ timestamp —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –∫–µ—à—É–≤–∞–Ω–Ω—è –±—Ä–∞—É–∑–µ—Ä–æ–º
                const url = `https://raw.githubusercontent.com/${CONFIG.owner}/${CONFIG.repo}/main/${CONFIG.path}?t=${new Date().getTime()}`;
                const response = await fetch(url);
                if (!response.ok) throw new Error('–§–∞–π–ª –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                tasks = await response.json();
                renderTasks();
                updateStatus('–î–∞–Ω—ñ –∞–∫—Ç—É–∞–ª—å–Ω—ñ', 'bg-green-500');
            } catch (error) {
                console.error(error);
                updateStatus('–ê—Ä—Ö—ñ–≤ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ (—Å—Ç–≤–æ—Ä—ñ—Ç—å —Ñ–∞–π–ª)', 'bg-orange-500');
            }
        }

        // 2. –°–ò–ù–•–†–û–ù–Ü–ó–ê–¶–Ü–Ø (–ß–µ—Ä–µ–∑ Repository Dispatch)
        async function saveToGitHub() {
            const token = getToken();
            if (!token) return;

            updateStatus('–ó–∞–ø—É—Å–∫ GitHub Action...', 'bg-blue-500');
            document.getElementById('loadingSpinner').classList.remove('hidden');

            try {
                const response = await fetch(`https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        event_type: 'update-tasks',
                        client_payload: {
                            tasks: JSON.stringify(tasks, null, 2)
                        }
                    })
                });

                if (response.ok) {
                    updateStatus('Action –∑–∞–ø—É—â–µ–Ω–æ! –û–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞ 20—Å', 'bg-indigo-500');
                    // –ê–≤—Ç–æ-–æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ 25 —Å–µ–∫—É–Ω–¥, –∫–æ–ª–∏ Action –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–æ–±–æ—Ç—É
                    setTimeout(fetchFromGitHub, 25000);
                } else {
                    const err = await response.json();
                    throw new Error(err.message);
                }
            } catch (error) {
                alert("–ü–æ–º–∏–ª–∫–∞: " + error.message);
                updateStatus('–ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É', 'bg-red-500');
            } finally {
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        }

        function renderTasks() {
            const list = document.getElementById('taskList');
            list.innerHTML = '';
            tasks.forEach((task, index) => {
                const li = document.createElement('li');
                li.className = "flex justify-between items-center bg-slate-50 p-4 rounded-xl border border-slate-100 group";
                li.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-slate-800 font-medium">${task.text}</span>
                        <span class="text-[10px] text-slate-400 uppercase italic">${new Date(task.date).toLocaleString()}</span>
                    </div>
                    <button onclick="deleteTask(${index})" class="text-red-400 hover:text-red-600 p-2">–í–∏–¥–∞–ª–∏—Ç–∏</button>
                `;
                list.appendChild(li);
            });
        }

        async function addTask() {
            const input = document.getElementById('taskInput');
            if (input.value.trim()) {
                tasks.push({ text: input.value, date: new Date().toISOString() });
                input.value = '';
                renderTasks();
                await saveToGitHub();
            }
        }

        async function deleteTask(index) {
            tasks.splice(index, 1);
            renderTasks();
            await saveToGitHub();
        }

        function updateStatus(text, colorClass) {
            document.getElementById('statusIndicator').className = `w-3 h-3 rounded-full ${colorClass}`;
            document.getElementById('statusText').innerText = text;
        }

        fetchFromGitHub();
    </script>
</body>
</html>
